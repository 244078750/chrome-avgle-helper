(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a;}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r);},p,p.exports,r,e,n,t);}return n[i].exports;}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o;}return r;})()({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});class TabStorage{constructor(){this.map=new Map();}delete(tabId){this.map.delete(tabId);}update(tabId,object){const oldObject=this.map.get(tabId);object=Object.assign(oldObject||{},object);this.map.set(tabId,object);}get(tabId){return this.map.get(tabId)||{};}}exports.TabStorage=TabStorage;},{}],2:[function(require,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});const M3U8_PATTERN_ARRAY=exports.M3U8_PATTERN_ARRAY=['*://*/*.m3u8','*://*/*.m3u8?*','*://gooqlevideo.xyz/playback/*'];const PROCESSABLE_M3U8_PATTERN=exports.PROCESSABLE_M3U8_PATTERN=[{pattern:/\.\w+cdn\.com\//},{pattern:/\.cdn\.qooqlevideo\.com\//},{pattern:/\/playback\//,base64Encoded:true},{pattern:/\w+\.xvideos-cdn\.com/}];const VIDEO_PAGE_PATTERN=exports.VIDEO_PAGE_PATTERN=[{pattern:/^(https|http):\/\/avgle.com\/video\/\w+/,type:'avgle'},{pattern:/^(https|http):\/\/(?:www\.)xvideos.com\/video\w+/,type:'xvideos'}];},{}],3:[function(require,module,exports){(function(global){"use strict";var _config=require("./config");var _mainPlayerPage=require("./inject/main-player-page");var _tabStorage=require("./background/tab-storage");var _logger=require("./logger");var log=_interopRequireWildcard(_logger);function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj;}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key];}}newObj.default=obj;return newObj;}}log.info('Chrome Avgle Helper background script started!');log.info(`Extension id: ${chrome.runtime.id}`);const exportToGloabl=(name,value)=>global[name]=value;exportToGloabl('__avgle_helper_context',{openConsolePage,queryTabStorage});const tabStorage=new _tabStorage.TabStorage();chrome.tabs.onRemoved.addListener(tabId=>tabStorage.delete(tabId));registerLoggerConnectForConsolePage();registerDownloadCommandMessageListener();chrome.webRequest.onBeforeRequest.addListener(details=>{if(details.tabId<0)return;log.info([`Captured m3u8 request`,`  tabId: ${details.tabId}`,`  ${details.method} ${details.url}`].join('\n'));chrome.tabs.get(details.tabId,tab=>{if(!tab)return log.error(`Cannot find tab with id ${details.tabId}`);log.info(`Tab title: ${tab.title}`);log.info(`Tab URL: ${tab.url}`);let matchedPage=_config.VIDEO_PAGE_PATTERN.find(it=>it.pattern.test(tab.url));if(!matchedPage)return log.info(`Ignore: URL of tab is not matched in VIDEO_PAGE_PATTERN`);let m3u8URL=details.url;let m3u8URLBase64=btoa(m3u8URL);let matchedProcesser=_config.PROCESSABLE_M3U8_PATTERN.find(it=>it.pattern.test(m3u8URL));if(!matchedProcesser)return log.info(`Ignore: URL of m3u8 request is not matched with any pattern in PROCESSABLE_M3U8_PATTERN`);const context={m3u8URLBase64,tabURL:tab.url,pageType:matchedPage.type,needDecode:matchedProcesser.base64Encoded};tabStorage.update(tab.id,context);injectScript(null,context);function injectScript(error,parameters={}){if(error){if(typeof error!='string')error='message'in error?`${error.message}\n${error.stack}`:String(error);parameters.error=error;}chrome.tabs.executeScript(details.tabId,{code:(0,_mainPlayerPage.getInjectScript)(parameters)},()=>{log.info('Inject script success!');});}});},{urls:_config.M3U8_PATTERN_ARRAY});function registerLoggerConnectForConsolePage(){chrome.runtime.onConnect.addListener(port=>{if(port.name!="console"){log.error(`unknown connection with name: ${port.name}`);return port.disconnect();}log.info('log connection established','muted');log.bindLogCallback(log=>port.postMessage(log));port.postMessage(log.getLogHistoryHTML());port.onMessage.addListener(msg=>{if(msg=='clear-log'){log.clearLogHistory();log.info('log cleared','muted');return;}});port.onDisconnect.addListener(()=>{log.unbindLogCallback();log.info('log connection disconnected','muted');});});}function registerDownloadCommandMessageListener(){chrome.runtime.onMessage.addListener((message,sender,response)=>{if(!message||!sender||!sender.tab||!sender.tab.id)return;const{tab}=sender;log.info(`Video name: ${message.carNumber}`);tabStorage.update(tab.id,{carNumber:message.carNumber});});}function queryTabStorage(tabId){return tabStorage.get(tabId);}function openConsolePage(){const url=chrome.extension.getURL('dist/console/index.html');chrome.tabs.query({url},tabs=>{if(tabs.length>0){const tab=tabs[0];chrome.tabs.update(tab.id,{active:true},noop);return;}chrome.tabs.create({url,active:false},tab=>{chrome.windows.create({tabId:tab.id,type:'popup',focused:true,width:800,height:400},noop);});});function noop(){}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"./background/tab-storage":1,"./config":2,"./inject/main-player-page":4,"./logger":6}],4:[function(require,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.getInjectScript=getInjectScript;var _utils=require('./utils');var _utils2=_interopRequireDefault(_utils);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function getInjectScript(paramters){const injectHelperName='chromeAvgleHelper';return`
		${_utils2.default.getInjectUtilsScript(injectHelperName)};
		(${main.toString()})(
			${injectHelperName},
			${JSON.stringify(paramters)}
		);`;}function main(utils,paramters={}){const{$,el}=utils;const injectBoxClassName='chrome-avgle-extension-inject-box';const injectCarNumberClassName='chrome-avgle-extension-player-car-number';const pageType=paramters.pageType;const tabURL=String(paramters.tabURL||'');const m3u8URLBase64=String(paramters.m3u8URLBase64||'');let videoTitleDOM=$('.container .row .col-lg-12 h1');let tipTitle='Download Commands:';if(pageType==='avgle')tipTitle='Avgle Download Commands:';else if(pageType==='xvideos')tipTitle='XVIDEOS Download Commands:';let command='';let carNumber=getDefaultCarNumber();let downloaderOpts=[];if(pageType==='avgle'){const node=Array.from(videoTitleDOM.childNodes).find(it=>it.nodeType===Node.TEXT_NODE);let videoTitle=node.textContent;let _carNumber=utils.parseCarNumber(videoTitle);if(_carNumber)node.parentNode.insertBefore(createCarNumberElement(carNumber=_carNumber),node);}if(pageType==='xvideos')downloaderOpts.push('type=xvideos');if(paramters.needDecode)downloaderOpts.push('decode=true');downloaderOpts.push(`name=${carNumber}`);downloaderOpts.push(`url=${m3u8URLBase64}`);command=[`AvgleDownloader ${downloaderOpts.join(' ')};`,`Avgle ${carNumber}; # combine video files`].join('\n');if(pageType==='avgle'){const videoColumn=$('.video-container').parentNode.parentNode;videoColumn.className="col-lg-12 col-md-12 col-sm-12";}const injectContainer=getInjectContainer();if(injectContainer){const injectBox=el('div',{display:'flex',flexDirection:'column',color:'#282828',backgroundColor:'#f7f7f7',border:'1px solid #ccc',borderRadius:'4px'},{class:injectBoxClassName},[el('div',{padding:'5px 0 0 10px',fontSize:'15px',color:'#888'},null,tipTitle),el('pre',{padding:'5px 15px 9px 15px',margin:'0',fontSize:'13px',lineHeight:'1.5',wordBreak:'break-all',wordWrap:'break-word',border:'none'},null,el('code',{padding:0,fontSize:'13px',color:'#222222',backgroundColor:'transparent',whiteSpace:'pre-wrap'},null,command))]);injectContainer.appendChild(injectBox);}chrome.runtime.sendMessage({carNumber});function getInjectContainer(){let injectContainer;if(pageType==='avgle'){injectContainer=videoTitleDOM.parentNode.parentNode;}else if(pageType==='xvideos'){injectContainer=$('.video-metadata.video-tags-list');}if(injectContainer){const oldBox=$(`.${injectBoxClassName}`,injectContainer);if(oldBox)oldBox.parentNode.removeChild(oldBox);}return injectContainer;}function getDefaultCarNumber(){if(pageType==='avgle'){const avgleId=tabURL.match(/\/video\/(\w+)\//);return`avgle-${avgleId?avgleId[1]:'unknown'}`;}if(pageType==='xvideos'){const videoId=tabURL.match(/\/(video\w+)\//);return`xvideos-${videoId?videoId[1]:'unknown'}`;}return'unknown';}function createCarNumberElement(carNumber){return el('b',{color:'#77b300',margin:'0 0.5em',fontSize:'18px'},{class:injectCarNumberClassName},carNumber);}}},{"./utils":5}],5:[function(require,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});const utilsFunctions={getInjectUtilsScript,el,$,$$,escapeHTML,parseCarNumber};exports.default=utilsFunctions;function getInjectUtilsScript(globalVariableName){let result=`window.${globalVariableName} = {};`;result+=Object.keys(utilsFunctions).filter(funcName=>funcName!=='getInjectUtilsScript').map(funcName=>{const funcBody=utilsFunctions[funcName].toString();return`${globalVariableName}.${funcName} = (${funcBody});`;}).join('');return result;}function el(tageName,style,attrs,children){const element=document.createElement(tageName);if(style)Object.keys(style).forEach(key=>element.style[key]=style[key]);if(attrs)Object.keys(attrs).forEach(key=>element.setAttribute(key,attrs[key]));if(children){if(Array.isArray(children))children.forEach(child=>element.append(child));else element.append(children);}return element;}function $(selector,element){return(element||document).querySelector(selector);}function $$(selector,element){return Array.from((element||document).querySelectorAll(selector)||[]);}function escapeHTML(text){return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}function parseCarNumber(str=''){const matchers=[[/Tokyo[-\s]+Hot[-\s]+(\w{4,6})/i,match=>`Tokyo-Hot-${match[1]}`],[/AXDVD[-\s+](\d{3,5}\w)/i,match=>`AXDVD-${match[1]}`],[/LOVE[-\s](\d{3,4})/i,match=>`LOVE-${match[1]}`],[/10musume[-_\s](\d{6})[-_\s](\d{2})/i,match=>`10musume-${match[1]}-${match[2]}`],[/fc2[\s\-_]?ppv[\s\-_]?(\d+)/i,match=>`FC2-PPV-${match[1]}`],[/S-Cute\s+(\w+)\s+#(\d+)/i,match=>`S-Cute-${match[1]}-${match[2]}`],[/Heydouga[-_\s]?(\d+)[-_\s]?(\d+)/i,match=>`Heydouga-${match[1]}-${match[2]}`],[/heyzo[-_\s]?(\d+)/i,match=>`heyzo-${match[1]}`],[/(\d+)[-_\s](\d+)[-_\s]Carib(?:bean(?:com)?)?/i,match=>`carib-${match[1]}-${match[2]}`],[/Carib(?:bean(?:com)?)?[-_\s]?(\d+)[-_\s]?(\d+)/i,match=>`carib-${match[1]}-${match[2]}`],[/(?:kbj|korean).+bj(20\d+)/i,match=>`Korean-BJ-${match[1]}`],/\w+-\d+/i,[/(\w{8,})[-_\s](\d{5,})[-_\s](\d{3,})/,match=>`${match[1]}-${match[2]}-${match[3]}`]];for(let matcher of matchers){if(Array.isArray(matcher)){let result=str.match(matcher[0]);if(result)return matcher[1](result);}else{let result=str.match(matcher);if(result)return result[0];}}return null;}},{}],6:[function(require,module,exports){'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.bindLogCallback=bindLogCallback;exports.unbindLogCallback=unbindLogCallback;exports.info=info;exports.error=error;exports.clearLogHistory=clearLogHistory;exports.getLogHistoryHTML=getLogHistoryHTML;const MAX_HISTORY=1000;const AVG_HISTORY=700;let history=[];let logCallback=undefined;function push2history(content,type="info"){let ctx={t:Date.now(),c:content,type};if(history.length>=MAX_HISTORY)history=history.slice(MAX_HISTORY-AVG_HISTORY);history.push(ctx);if(logCallback)logCallback(logItem2html(ctx));return ctx;}let escapeMap={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;',' ':'&nbsp'};let escape=text=>text.replace(/[&<>"'`=/ ]/g,matched=>escapeMap[matched]);function bindLogCallback(callback){logCallback=callback;}function unbindLogCallback(){logCallback=undefined;}function logItem2html(item){let d=new Date(item.t);let part=item.c.split(/(https?:\/\/\S+)/).map(ctx=>ctx.match(/^https?:\/\//)?`<a href="${encodeURI(ctx)}" target="_blank">${escape(decodeURI(ctx))}</a>`:escape(ctx).replace(/\n/g,'<br />'));return`<div class="item">
		<div class="prefix">${escape(d.toLocaleDateString()+" "+d.toLocaleTimeString())}</div>
		<div class="${item.type}">
			${part.join('')}
		</div>
	</div>`;}function info(content,type="info"){console.log(content);push2history(content,type);}function error(content){console.error(content);push2history(content,"error");}function clearLogHistory(){history=[];}function getLogHistoryHTML(){return history.map(logItem2html).join('\n');}},{}]},{},[3]);
//# sourceMappingURL=index.js.map